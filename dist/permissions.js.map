{"version":3,"sources":["permissions.js"],"names":[],"mappings":"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","file":"permissions.js","sourcesContent":["'use strict';\n\nimport _ from 'lodash';\nimport Q from 'q';\nimport errors from './errors';\n\nfunction match(check, allowed) {\n  return !allowed || allowed === '*' || !check || check === allowed;\n}\n\nfunction parse(token) {\n\n  if (!_.isString(token)) {\n    // Already parsed\n    return token;\n  }\n\n  var f = token.split(/::/);\n\n  return {\n    app: f.length > 0 ? f[0].toUpperCase() : undefined,\n    type: f.length > 1 ? f[1].toUpperCase() : undefined,\n    action: f.length > 2 ? f[2].toUpperCase() : undefined,\n    instance: f.length > 3 ? f[3] : undefined\n  };\n\n}\n\nfunction instances(permission, token) {\n  var p = parse(token);\n  permission = parse(permission);\n  if (match(p.app, permission.app) &&\n      match(p.type, permission.type) &&\n      match(p.action, permission.action)) {\n    return permission.instance ? permission.instance : '*';\n  }\n  return null;\n}\n\nfunction roleInstances(role, token) {\n\n  var ids = (role.permissions || []).reduce(function(accum, permission) {\n    var inst = instances(permission, token);\n    if (inst) {\n      accum.push(inst);\n    }\n    return accum;\n  }, []);\n\n  if (ids.length && ids.indexOf('*') > -1) {\n    return ['*'];\n  }\n\n  return ids;\n\n}\n\nfunction userInstances(user, token) {\n\n  var ids = [];\n\n  if (user.roles && user.roles.length) {\n\n    if (_.isString(user.roles[0])) {\n      throw new Error('user roles have not been populated');\n    }\n\n    ids = user.roles.reduce(function(accum, role) {\n      return accum.concat(roleInstances(role, token));\n    }, ids);\n\n  }\n\n  if (user.permissions && user.permissions.length) {\n    user.permissions.reduce(function(accum, perm) {\n      accum.push(instances(perm, token));\n      return accum;\n    }, ids);\n  }\n\n  if (ids.indexOf('*') > -1) {\n    return '*';\n  }\n\n  if (ids.length) {\n    return _.without(_.uniq(ids), null);\n  }\n\n  return false;\n\n}\n\nfunction permit(permission, token) {\n  var p = parse(token);\n  permission = parse(permission);\n  return match(p.app, permission.app) &&\n    match(p.type, permission.type) &&\n    match(p.action, permission.action) &&\n    match(p.instance, permission.instance);\n}\n\nfunction rolePermit(role, token) {\n  return (role.permissions || []).some(function(permission) {\n    return permit(permission, token);\n  });\n}\n\nfunction userPermit(user, token) {\n\n  if (!user) {\n    return errors.reject('You do not have permission to perform this action.', 403, 'PERMISSION_DENIED');\n  }\n\n  if ((user.roles || []).some(function(r) { return rolePermit(r, token); }) ||\n      (user.permissions || []).some(function(p) { return permit(p, token); })) {\n    return Q();\n  } else {\n    return errors.reject('You do not have permission to perform this action.', 403, 'PERMISSION_DENIED');\n  }\n\n}\n\nfunction userAction(user, permission, action) {\n  return userPermit(user, permission).then(function() {\n    return action ?\n      Q(action(userInstances(user, permission))) :\n      Q(userInstances(user, permission));\n  });\n}\n\nexport default {\n  do: userAction,\n  user: userPermit,\n  role: rolePermit,\n  permission: permit,\n  parse: parse\n};\n"],"sourceRoot":"/source/"}